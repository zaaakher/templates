variables:
  main_domain: ${randomDomain}
  huly_secret: ${generateBase64(64)}

config:
  domains:
    - serviceName: nginx
      port: 80
      host: ${main_domain}

  env:
    - HULY_VERSION=v0.6.377
    - DOCKER_NAME=huly
    - HOST_ADDRESS=${main_domain}
    - SECURE=
    - HTTP_PORT=80
    - HTTP_BIND=
    - TITLE=Huly
    - DEFAULT_LANGUAGE=en
    - LAST_NAME_FIRST=true
    - SECRET=${huly_secret}

  mounts:
    - filePath: /volumes/nginx/.huly.nginx
      content: |
        server {
            listen 80;
            server_name _;
            location / {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_pass http://front:8080;
            }

            location /_accounts {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                rewrite ^/_accounts(/.*)$ $1 break;
                proxy_pass http://account:3000/;
            }

            location /_collaborator {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                rewrite ^/_collaborator(/.*)$ $1 break;
                proxy_pass http://collaborator:3078/;
            }

            location /_transactor {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                rewrite ^/_transactor(/.*)$ $1 break;
                proxy_pass http://transactor:3333/;
            }

            location ~ ^/eyJ {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_pass http://transactor:3333;
            }

            location /_rekoni {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                rewrite ^/_rekoni(/.*)$ $1 break;
                proxy_pass http://rekoni:4004/;
            }

            location /_stats {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                rewrite ^/_stats(/.*)$ $1 break;
                proxy_pass http://stats:4900/;
            }
        } 